# azure.yaml file for UKG Sync Backend deployment
name: ukg-sync-backend
metadata:
  template: ukg-sync-backend@0.0.1-beta

services:
  ukg-sync-backend:
    project: .
    language: js
    host: function
    hooks:
      prebuild:
        shell: pwsh
        run: |
          Write-Host "Installing dependencies..."
          npm ci
          Write-Host "Building TypeScript..."
          npm run build
      predeploy:
        shell: pwsh
        run: |
          Write-Host "Preparing deployment package..."
          # Copy built files and package.json to dist folder
          if (Test-Path "dist") { Remove-Item -Recurse -Force "dist" }
          New-Item -ItemType Directory -Force -Path "dist"
          Copy-Item "package.json" "dist/"
          Copy-Item "package-lock.json" "dist/" -ErrorAction SilentlyContinue
          Copy-Item "host.json" "dist/"
          # Copy the entire lib directory contents
          if (Test-Path "lib") { 
            Copy-Item -Recurse "lib/*" "dist/" -Force 
          }
          # Fix package.json main field for deployment
          $packageJson = Get-Content "dist\package.json" -Raw | ConvertFrom-Json
          $packageJson.main = "index.js"
          $packageJson | ConvertTo-Json -Depth 100 | Out-File "dist\package.json" -Encoding utf8
          # Install production dependencies in dist folder
          Push-Location "dist"
          npm install --only=production
          Pop-Location
          Write-Host "Deployment package ready"
