<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PAR Brink ‚Üí UKG Ready ETL Pipeline - Complete Test</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: #333;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        overflow: hidden;
      }
      .header {
        background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        color: white;
        padding: 30px;
        text-align: center;
      }
      .header h1 {
        margin: 0;
        font-size: 2.5em;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      }
      .header p {
        margin: 10px 0 0 0;
        opacity: 0.9;
      }
      .content {
        padding: 30px;
      }
      .section {
        margin-bottom: 40px;
        padding: 25px;
        border-radius: 10px;
        border-left: 5px solid #3498db;
        background: #f8f9fa;
      }
      .section h2 {
        margin-top: 0;
        color: #2c3e50;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .btn {
        background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        color: white;
        border: none;
        padding: 12px 25px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
        margin: 10px 5px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      }
      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
      }
      .btn:disabled {
        background: #bdc3c7;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }
      .btn.success {
        background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
      }
      .btn.warning {
        background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
      }
      .btn.danger {
        background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
      }
      .output {
        background: #2c3e50;
        color: #ecf0f1;
        padding: 20px;
        border-radius: 6px;
        font-family: "Courier New", monospace;
        font-size: 14px;
        line-height: 1.5;
        white-space: pre-wrap;
        overflow-x: auto;
        margin: 15px 0;
        max-height: 400px;
        overflow-y: auto;
        border: 2px solid #34495e;
      }
      .status {
        display: inline-block;
        padding: 5px 12px;
        border-radius: 15px;
        font-size: 12px;
        font-weight: bold;
        text-transform: uppercase;
        margin-left: 10px;
      }
      .status.pending {
        background: #f39c12;
        color: white;
      }
      .status.success {
        background: #27ae60;
        color: white;
      }
      .status.error {
        background: #e74c3c;
        color: white;
      }
      .metrics {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin: 20px 0;
      }
      .metric {
        background: white;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
        border: 2px solid #ecf0f1;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .metric .value {
        font-size: 2em;
        font-weight: bold;
        color: #3498db;
        margin-bottom: 5px;
      }
      .metric .label {
        color: #7f8c8d;
        font-size: 0.9em;
      }
      .pipeline-flow {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 20px 0;
        padding: 20px;
        background: linear-gradient(135deg, #ecf0f1 0%, #bdc3c7 100%);
        border-radius: 10px;
      }
      .flow-step {
        text-align: center;
        flex: 1;
        padding: 10px;
      }
      .flow-arrow {
        font-size: 2em;
        color: #3498db;
        margin: 0 10px;
      }
      .icon {
        margin-right: 8px;
      }
      .progress-bar {
        width: 100%;
        height: 20px;
        background: #ecf0f1;
        border-radius: 10px;
        overflow: hidden;
        margin: 10px 0;
      }
      .progress-fill {
        height: 100%;
        background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        width: 0%;
        transition: width 0.3s ease;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üîÑ PAR Brink ‚Üí UKG Ready ETL Pipeline</h1>
        <p>Complete End-to-End Integration Test with Safety Protection</p>
      </div>

      <div class="content">
        <!-- Safety Status Section -->
        <div class="section">
          <h2><span class="icon">üõ°Ô∏è</span>Safety Status</h2>
          <button class="btn success" onclick="checkTenantSafety()">
            <span class="icon">üîç</span>Verify Tenant Safety
          </button>
          <div id="safetyOutput" class="output" style="display: none"></div>
          <div id="safetyStatus" class="status pending">Checking Safety...</div>
        </div>

        <!-- Pipeline Overview -->
        <div class="section">
          <h2><span class="icon">üèóÔ∏è</span>Pipeline Architecture</h2>
          <div class="pipeline-flow">
            <div class="flow-step">
              <div style="font-size: 2em">üè™</div>
              <div>
                <strong>PAR Brink</strong><br />SOAP API<br />Castle Rock Store
              </div>
            </div>
            <div class="flow-arrow">‚Üí</div>
            <div class="flow-step">
              <div style="font-size: 2em">‚öôÔ∏è</div>
              <div>
                <strong>ETL Engine</strong><br />Extract, Transform<br />Data
                Mapping
              </div>
            </div>
            <div class="flow-arrow">‚Üí</div>
            <div class="flow-step">
              <div style="font-size: 2em">üéØ</div>
              <div>
                <strong>UKG Ready</strong><br />REST API<br />Chuck Demo Tenant
              </div>
            </div>
          </div>
        </div>

        <!-- Step 1: PAR Brink Data Extraction -->
        <div class="section">
          <h2><span class="icon">1Ô∏è‚É£</span>PAR Brink Data Extraction</h2>
          <p>
            Extract employee data from PAR Brink Castle Rock location using SOAP
            API
          </p>
          <button class="btn" onclick="testParBrinkExtraction()">
            <span class="icon">üìä</span>Extract PAR Brink Data
          </button>
          <div id="parBrinkOutput" class="output" style="display: none"></div>
          <div id="parBrinkMetrics" class="metrics" style="display: none"></div>
        </div>

        <!-- Step 2: UKG Ready Authentication -->
        <div class="section">
          <h2><span class="icon">2Ô∏è‚É£</span>UKG Ready Authentication</h2>
          <p>Authenticate with UKG Ready Chuck Demo tenant using OAuth2</p>
          <button class="btn" onclick="testUkgAuthentication()">
            <span class="icon">üîë</span>Authenticate with UKG
          </button>
          <div id="ukgAuthOutput" class="output" style="display: none"></div>
        </div>

        <!-- Step 3: Data Transformation -->
        <div class="section">
          <h2><span class="icon">3Ô∏è‚É£</span>Data Transformation & Mapping</h2>
          <p>Transform PAR Brink employee records to UKG Ready format</p>
          <button class="btn" onclick="testDataTransformation()">
            <span class="icon">üîÑ</span>Transform Data
          </button>
          <div id="transformOutput" class="output" style="display: none"></div>
        </div>

        <!-- Step 4: Complete ETL Pipeline -->
        <div class="section">
          <h2><span class="icon">4Ô∏è‚É£</span>Complete ETL Pipeline Execution</h2>
          <p>Run the full end-to-end ETL process with safety checks</p>
          <div class="progress-bar">
            <div id="etlProgress" class="progress-fill"></div>
          </div>
          <button class="btn success" onclick="runCompleteETL()">
            <span class="icon">üöÄ</span>Run Complete ETL Pipeline
          </button>
          <button class="btn warning" onclick="runETLWithLimits()">
            <span class="icon">‚ö†Ô∏è</span>Run with Safety Limits (5 records)
          </button>
          <div id="etlOutput" class="output" style="display: none"></div>
          <div id="etlMetrics" class="metrics" style="display: none"></div>
        </div>

        <!-- Step 5: Results Verification -->
        <div class="section">
          <h2><span class="icon">5Ô∏è‚É£</span>Results Verification</h2>
          <p>Verify data sync success and check UKG Ready records</p>
          <button class="btn" onclick="verifyResults()">
            <span class="icon">‚úÖ</span>Verify Sync Results
          </button>
          <div id="verifyOutput" class="output" style="display: none"></div>
        </div>
      </div>
    </div>

    <script>
      const API_BASE = "http://localhost:7071/api";

      // Utility functions
      function showOutput(elementId, content) {
        const element = document.getElementById(elementId);
        element.style.display = "block";
        element.textContent = content;
      }

      function updateProgress(percentage) {
        document.getElementById("etlProgress").style.width = percentage + "%";
      }

      function createMetric(value, label) {
        return `<div class="metric"><div class="value">${value}</div><div class="label">${label}</div></div>`;
      }

      // Step 0: Check tenant safety
      async function checkTenantSafety() {
        try {
          showOutput(
            "safetyOutput",
            "Checking tenant safety configuration...\n"
          );

          const response = await fetch(`${API_BASE}/tenants`);
          const result = await response.json();

          if (result.success && result.data) {
            const activeTenants = result.data;
            let safetyReport = `Safety Check Results:\n\n`;
            safetyReport += `Active Tenants: ${activeTenants.length}\n`;

            activeTenants.forEach((tenant) => {
              safetyReport += `- ${tenant.tenantName} (${tenant.id})\n`;
              safetyReport += `  Company ID: ${tenant.companyId}\n`;
              safetyReport += `  Base URL: ${tenant.baseUrl}\n\n`;
            });

            const hasMerbree = activeTenants.some((t) =>
              t.tenantName.toLowerCase().includes("merbree")
            );
            const hasChuckDemo = activeTenants.some((t) =>
              t.tenantName.toLowerCase().includes("chuck demo")
            );

            if (hasMerbree) {
              safetyReport += `‚ùå WARNING: Merbree tenant is still active!\n`;
              safetyReport += `‚ö†Ô∏è Live client data is at risk!\n`;
              document.getElementById("safetyStatus").className =
                "status error";
              document.getElementById("safetyStatus").textContent =
                "UNSAFE - Merbree Active";
            } else if (hasChuckDemo) {
              safetyReport += `‚úÖ SAFE: Only Chuck Demo tenant is active\n`;
              safetyReport += `üõ°Ô∏è Merbree tenant is protected (inactive)\n`;
              document.getElementById("safetyStatus").className =
                "status success";
              document.getElementById("safetyStatus").textContent =
                "SAFE - Protected";
            } else {
              safetyReport += `‚ö†Ô∏è WARNING: No Chuck Demo tenant found\n`;
              document.getElementById("safetyStatus").className =
                "status error";
              document.getElementById("safetyStatus").textContent =
                "ERROR - No Test Tenant";
            }

            showOutput("safetyOutput", safetyReport);
          } else {
            showOutput(
              "safetyOutput",
              "Error checking tenant safety: " + result.error
            );
            document.getElementById("safetyStatus").className = "status error";
            document.getElementById("safetyStatus").textContent = "ERROR";
          }
        } catch (error) {
          showOutput("safetyOutput", "Safety check failed: " + error.message);
          document.getElementById("safetyStatus").className = "status error";
          document.getElementById("safetyStatus").textContent = "FAILED";
        }
      }

      // Step 1: Test PAR Brink extraction
      async function testParBrinkExtraction() {
        try {
          updateProgress(10);
          showOutput("parBrinkOutput", "Connecting to PAR Brink SOAP API...\n");

          const response = await fetch(`${API_BASE}/parBrinkExtract`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              storeId: "Castle Rock",
              maxRecords: 50,
            }),
          });

          const result = await response.json();
          updateProgress(25);

          if (result.success) {
            const employees = result.data || [];
            let output = `PAR Brink Extraction Successful!\n\n`;
            output += `Store: ${result.storeId || "Castle Rock"}\n`;
            output += `Employees Found: ${employees.length}\n`;
            output += `Extraction Time: ${new Date().toLocaleTimeString()}\n\n`;

            if (employees.length > 0) {
              output += `Sample Employee Records:\n`;
              employees.slice(0, 3).forEach((emp, index) => {
                output += `${index + 1}. ${emp.FirstName} ${emp.LastName}\n`;
                output += `   Employee ID: ${emp.EmployeeId}\n`;
                output += `   Job Title: ${emp.JobTitle || "N/A"}\n`;
                output += `   Hire Date: ${emp.HireDate || "N/A"}\n\n`;
              });
            }

            showOutput("parBrinkOutput", output);

            // Show metrics
            const metricsHtml =
              createMetric(employees.length, "Employees") +
              createMetric(result.storeId || "Castle Rock", "Store Location") +
              createMetric("SOAP", "API Protocol") +
              createMetric("Active", "Connection Status");
            document.getElementById("parBrinkMetrics").innerHTML = metricsHtml;
            document.getElementById("parBrinkMetrics").style.display = "grid";
          } else {
            showOutput(
              "parBrinkOutput",
              "PAR Brink extraction failed: " + result.error
            );
          }
          updateProgress(30);
        } catch (error) {
          showOutput(
            "parBrinkOutput",
            "PAR Brink extraction error: " + error.message
          );
          updateProgress(0);
        }
      }

      // Step 2: Test UKG authentication
      async function testUkgAuthentication() {
        try {
          updateProgress(35);
          showOutput(
            "ukgAuthOutput",
            "Authenticating with UKG Ready OAuth2...\n"
          );

          const response = await fetch(`${API_BASE}/ukgAuth`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              tenantName: "Chuck Demo",
            }),
          });

          const result = await response.json();
          updateProgress(50);

          if (result.success) {
            let output = `UKG Ready Authentication Successful!\n\n`;
            output += `Tenant: ${result.tenantName}\n`;
            output += `Company ID: ${result.companyId}\n`;
            output += `Base URL: ${result.baseUrl}\n`;
            output += `Token Type: ${result.tokenType || "Bearer"}\n`;
            output += `Token Expires: ${
              result.expiresIn ? result.expiresIn + " seconds" : "N/A"
            }\n`;
            output += `Authentication Time: ${new Date().toLocaleTimeString()}\n\n`;
            output += `‚úÖ Ready for data operations\n`;

            showOutput("ukgAuthOutput", output);
          } else {
            showOutput(
              "ukgAuthOutput",
              "UKG authentication failed: " + result.error
            );
          }
        } catch (error) {
          showOutput(
            "ukgAuthOutput",
            "UKG authentication error: " + error.message
          );
          updateProgress(0);
        }
      }

      // Step 3: Test data transformation
      async function testDataTransformation() {
        try {
          updateProgress(55);
          showOutput(
            "transformOutput",
            "Testing data transformation logic...\n"
          );

          const response = await fetch(`${API_BASE}/transformTest`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              sampleSize: 5,
            }),
          });

          const result = await response.json();
          updateProgress(70);

          if (result.success) {
            let output = `Data Transformation Test Successful!\n\n`;
            output += `Records Transformed: ${result.transformedCount}\n`;
            output += `Mapping Rules Applied: ${
              result.mappingRules || "Standard"
            }\n`;
            output += `Validation Passed: ${
              result.validationPassed ? "Yes" : "No"
            }\n\n`;

            if (result.sampleTransformation) {
              output += `Sample Transformation:\n`;
              output += `PAR Brink ‚Üí UKG Ready\n`;
              output += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
              Object.entries(result.sampleTransformation).forEach(
                ([key, value]) => {
                  output += `${key}: ${JSON.stringify(value)}\n`;
                }
              );
            }

            showOutput("transformOutput", output);
          } else {
            showOutput(
              "transformOutput",
              "Data transformation test failed: " + result.error
            );
          }
        } catch (error) {
          showOutput(
            "transformOutput",
            "Data transformation error: " + error.message
          );
          updateProgress(0);
        }
      }

      // Step 4: Run complete ETL pipeline
      async function runCompleteETL() {
        await runETLPipeline(false);
      }

      async function runETLWithLimits() {
        await runETLPipeline(true);
      }

      async function runETLPipeline(withLimits = false) {
        try {
          updateProgress(0);
          showOutput("etlOutput", "Starting complete ETL pipeline...\n\n");

          let output = `üöÄ ETL Pipeline Execution Started\n`;
          output += `Safety Mode: ${
            withLimits ? "Limited (5 records)" : "Full extraction"
          }\n`;
          output += `Timestamp: ${new Date().toLocaleString()}\n\n`;

          // Phase 1: Extract
          updateProgress(20);
          output += `Phase 1: Extracting from PAR Brink...\n`;
          showOutput("etlOutput", output);

          const extractResponse = await fetch(`${API_BASE}/parBrinkToUkgETL`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              sourceStore: "Castle Rock",
              targetTenant: "Chuck Demo",
              maxRecords: withLimits ? 5 : 100,
              dryRun: false,
            }),
          });

          updateProgress(90);
          const etlResult = await extractResponse.json();

          if (etlResult.success) {
            output += `‚úÖ ETL Pipeline Completed Successfully!\n\n`;
            output += `üìä Final Results:\n`;
            output += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
            output += `Source Records: ${etlResult.sourceRecords || 0}\n`;
            output += `Transformed: ${etlResult.transformedRecords || 0}\n`;
            output += `Successfully Synced: ${etlResult.syncedRecords || 0}\n`;
            output += `Errors: ${etlResult.errorCount || 0}\n`;
            output += `Processing Time: ${
              etlResult.processingTime || "N/A"
            }\n\n`;

            if (etlResult.errors && etlResult.errors.length > 0) {
              output += `‚ö†Ô∏è Errors encountered:\n`;
              etlResult.errors.forEach((error, index) => {
                output += `${index + 1}. ${error}\n`;
              });
              output += `\n`;
            }

            output += `‚ú® Pipeline Status: COMPLETED\n`;
            updateProgress(100);

            // Show metrics
            const metricsHtml =
              createMetric(etlResult.sourceRecords || 0, "Extracted") +
              createMetric(etlResult.transformedRecords || 0, "Transformed") +
              createMetric(etlResult.syncedRecords || 0, "Synced") +
              createMetric(etlResult.processingTime || "0s", "Duration");
            document.getElementById("etlMetrics").innerHTML = metricsHtml;
            document.getElementById("etlMetrics").style.display = "grid";
          } else {
            output += `‚ùå ETL Pipeline Failed: ${etlResult.error}\n\n`;
            if (etlResult.details) {
              output += `Error Details:\n${etlResult.details}\n`;
            }
            updateProgress(0);
          }

          showOutput("etlOutput", output);
        } catch (error) {
          showOutput("etlOutput", "ETL Pipeline error: " + error.message);
          updateProgress(0);
        }
      }

      // Step 5: Verify results
      async function verifyResults() {
        try {
          showOutput(
            "verifyOutput",
            "Verifying sync results in UKG Ready...\n"
          );

          const response = await fetch(`${API_BASE}/ukgEmployees`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              tenantName: "Chuck Demo",
              limit: 10,
            }),
          });

          const result = await response.json();

          if (result.success) {
            const employees = result.data || [];
            let output = `UKG Ready Verification Results\n\n`;
            output += `Total Employees in UKG: ${employees.length}\n`;
            output += `Verification Time: ${new Date().toLocaleTimeString()}\n\n`;

            if (employees.length > 0) {
              output += `Recent Employee Records:\n`;
              output += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
              employees.slice(0, 5).forEach((emp, index) => {
                output += `${index + 1}. ${emp.firstName || emp.FirstName} ${
                  emp.lastName || emp.LastName
                }\n`;
                output += `   Employee ID: ${
                  emp.employeeId || emp.EmployeeId
                }\n`;
                output += `   Status: ${
                  emp.status || emp.Status || "Active"
                }\n`;
                output += `   Last Modified: ${
                  emp.lastModified || emp.LastModified || "N/A"
                }\n\n`;
              });
            }

            output += `‚úÖ Verification Complete - Data Successfully Synced\n`;
            showOutput("verifyOutput", output);
          } else {
            showOutput("verifyOutput", "Verification failed: " + result.error);
          }
        } catch (error) {
          showOutput("verifyOutput", "Verification error: " + error.message);
        }
      }

      // Auto-run safety check on page load
      window.addEventListener("load", function () {
        setTimeout(checkTenantSafety, 1000);
      });
    </script>
  </body>
</html>
