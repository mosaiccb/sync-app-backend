<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PAR Brink SOAP API Local Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }
      .input-group {
        margin-bottom: 15px;
      }
      label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
      }
      input[type="text"],
      input[type="date"] {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-family: monospace;
      }
      button {
        background-color: #007cba;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-right: 10px;
        margin-bottom: 10px;
      }
      button:hover {
        background-color: #005a87;
      }
      button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }
      .results {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 15px;
        margin-top: 15px;
        white-space: pre-wrap;
        font-family: monospace;
        font-size: 12px;
        max-height: 400px;
        overflow-y: auto;
      }
      .error {
        background-color: #f8d7da;
        color: #721c24;
        border-color: #f5c6cb;
      }
      .success {
        background-color: #d4edda;
        color: #155724;
        border-color: #c3e6cb;
      }
      .soap-envelope {
        background-color: #e9ecef;
        border: 1px solid #ced4da;
        border-radius: 4px;
        padding: 10px;
        margin: 10px 0;
        font-family: monospace;
        font-size: 11px;
        white-space: pre-wrap;
        max-height: 200px;
        overflow-y: auto;
      }
      .endpoint-test {
        border-left: 4px solid #007cba;
        padding-left: 15px;
      }
      .test-header {
        color: #007cba;
        font-weight: bold;
        font-size: 18px;
        margin-bottom: 15px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üçï PAR Brink SOAP API Local Test</h1>
      <p>
        Test PAR Brink API calls directly from the browser to debug SOAP
        envelope issues.
      </p>

      <div class="input-group">
        <label for="accessToken">Access Token:</label>
        <input
          type="text"
          id="accessToken"
          placeholder="Enter your PAR Brink access token"
        />
        <button onclick="clearCredentials()" style="margin-left: 10px">
          Clear
        </button>
        <button onclick="restoreCredentials()" style="margin-left: 5px">
          Restore Test Values
        </button>
      </div>

      <div class="input-group">
        <label for="locationToken">Location Token:</label>
        <input
          type="text"
          id="locationToken"
          placeholder="Enter location token"
        />
      </div>

      <div class="input-group">
        <label for="businessDate">Business Date:</label>
        <input type="date" id="businessDate" />
      </div>

      <div class="input-group">
        <label for="baseUrl">Function App Base URL:</label>
        <input
          type="text"
          id="baseUrl"
          value="http://localhost:7071/api"
          placeholder="http://localhost:7071/api"
        />
        <button onclick="setLocalUrl()" style="margin-left: 10px">Local</button>
        <button onclick="setProdUrl()" style="margin-left: 5px">
          Production
        </button>
      </div>
    </div>

    <!-- Test Sales API -->
    <div class="container endpoint-test">
      <div class="test-header">üè™ Sales API Test</div>
      <button onclick="testSalesAPI()">Test Sales API</button>
      <button onclick="testSalesAPIDirectSOAP()">Test Direct SOAP Call</button>
      <div
        id="soapEnvelopeSales"
        class="soap-envelope"
        style="display: none"
      ></div>
      <div id="resultsSales" class="results" style="display: none"></div>
    </div>

    <!-- Test Employees API -->
    <div class="container endpoint-test">
      <div class="test-header">üë• Employees API Test</div>
      <button onclick="testEmployeesAPI()">Test Employees API</button>
      <button onclick="testEmployeesAPIDirectSOAP()">
        Test Direct SOAP Call
      </button>
      <div
        id="soapEnvelopeEmployees"
        class="soap-envelope"
        style="display: none"
      ></div>
      <div id="resultsEmployees" class="results" style="display: none"></div>
    </div>

    <!-- Test Labor Shifts API -->
    <div class="container endpoint-test">
      <div class="test-header">‚è∞ Labor Shifts API Test</div>
      <button onclick="testLaborShiftsAPI()">Test Labor Shifts API</button>
      <div id="resultsLaborShifts" class="results" style="display: none"></div>
    </div>

    <script>
      // Set today's date as default
      document.getElementById("businessDate").value = new Date()
        .toISOString()
        .split("T")[0];

      // Hardcoded test credentials for quick testing
      document.getElementById("accessToken").value =
        "abc123def456ghi789jklmnop";
      document.getElementById("locationToken").value =
        "RPNrrDYtnke+OHNLfy74/A==";

      // Set hardcoded backend URL based on environment
      if (
        window.location.hostname === "localhost" ||
        window.location.hostname === "127.0.0.1"
      ) {
        document.getElementById("baseUrl").value = "http://localhost:7071/api";
      } else {
        document.getElementById("baseUrl").value =
          "https://ukg-sync-backend-5rrqlcuxyzlvy.azurewebsites.net/api";
      }

      // Functions to manage test credentials
      function clearCredentials() {
        document.getElementById("accessToken").value = "";
        document.getElementById("locationToken").value = "";
      }

      function restoreCredentials() {
        document.getElementById("accessToken").value =
          "abc123def456ghi789jklmnop";
        document.getElementById("locationToken").value =
          "RPNrrDYtnke+OHNLfy74/A==";
        console.log("üîë Restored Castle Rock location credentials");
      }

      function setLocalUrl() {
        document.getElementById("baseUrl").value = "http://localhost:7071/api";
        console.log("üè† Switched to local Azure Functions");
      }

      function setProdUrl() {
        document.getElementById("baseUrl").value =
          "https://ukg-sync-backend-5rrqlcuxyzlvy.azurewebsites.net/api";
        console.log("‚òÅÔ∏è Switched to production Azure Functions");
      }

      function getInputValues() {
        return {
          accessToken: document.getElementById("accessToken").value.trim(),
          locationToken: document.getElementById("locationToken").value.trim(),
          businessDate: document.getElementById("businessDate").value,
          baseUrl: document.getElementById("baseUrl").value.trim(),
        };
      }

      function validateInputs(inputs, requireLocation = true) {
        if (!inputs.accessToken) {
          alert("Please enter an access token");
          return false;
        }
        if (requireLocation && !inputs.locationToken) {
          alert("Please enter a location token");
          return false;
        }
        if (!inputs.businessDate) {
          alert("Please enter a business date");
          return false;
        }
        return true;
      }

      function displayResults(elementId, data, isError = false) {
        const element = document.getElementById(elementId);
        element.style.display = "block";
        element.className = `results ${isError ? "error" : "success"}`;
        element.textContent = JSON.stringify(data, null, 2);
      }

      function displaySoapEnvelope(elementId, envelope) {
        const element = document.getElementById(elementId);
        element.style.display = "block";
        element.textContent = envelope;
      }

      // Test Sales API through Azure Function
      async function testSalesAPI() {
        const inputs = getInputValues();
        if (!validateInputs(inputs)) return;

        try {
          const response = await fetch(`${inputs.baseUrl}/par-brink/sales`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              accessToken: inputs.accessToken,
              locationToken: inputs.locationToken,
              businessDate: inputs.businessDate,
            }),
          });

          const data = await response.json();
          displayResults(
            "resultsSales",
            {
              status: response.status,
              statusText: response.statusText,
              data: data,
            },
            !response.ok
          );
        } catch (error) {
          displayResults(
            "resultsSales",
            {
              error: "Network Error",
              message: error.message,
              stack: error.stack,
            },
            true
          );
        }
      }

      // Test Direct SOAP Call for Sales
      async function testSalesAPIDirectSOAP() {
        const inputs = getInputValues();
        if (!validateInputs(inputs)) return;

        // Show the SOAP envelope we're going to send
        const soapEnvelope = `<?xml version="1.0" encoding="utf-8"?><soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:v2="http://www.brinksoftware.com/webservices/sales/v2" xmlns:sys="http://schemas.datacontract.org/2004/07/System"><soapenv:Header/><soapenv:Body><v2:GetOrders><v2:request><v2:BusinessDate>${inputs.businessDate}</v2:BusinessDate><v2:ModifiedTime><sys:DateTime>${inputs.businessDate}T21:13:42</sys:DateTime><sys:OffsetMinutes>-420</sys:OffsetMinutes></v2:ModifiedTime></v2:request></v2:GetOrders></soapenv:Body></soapenv:Envelope>`;

        displaySoapEnvelope(
          "soapEnvelopeSales",
          `SOAP Envelope (${soapEnvelope.length} chars):
${soapEnvelope}`
        );

        try {
          const response = await fetch(
            "https://api11.brinkpos.net/sales2.svc",
            {
              method: "POST",
              headers: {
                AccessToken: inputs.accessToken,
                LocationToken: inputs.locationToken,
                "Content-Type": "text/xml",
                SOAPAction:
                  "http://www.brinksoftware.com/webservices/sales/v2/ISalesWebService2/GetOrders",
              },
              body: soapEnvelope,
            }
          );

          const responseText = await response.text();
          displayResults(
            "resultsSales",
            {
              status: response.status,
              statusText: response.statusText,
              headers: Object.fromEntries(response.headers.entries()),
              responseText: responseText,
              soapEnvelopeLength: soapEnvelope.length,
            },
            !response.ok
          );
        } catch (error) {
          displayResults(
            "resultsSales",
            {
              error: "Direct SOAP Call Failed",
              message: error.message,
              stack: error.stack,
              soapEnvelopeUsed: soapEnvelope,
            },
            true
          );
        }
      }

      // Test Employees API through Azure Function
      async function testEmployeesAPI() {
        const inputs = getInputValues();
        if (!validateInputs(inputs, false)) return; // Location not strictly required for employees

        try {
          const response = await fetch(
            `${inputs.baseUrl}/par-brink/employees`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                accessToken: inputs.accessToken,
                locationToken: inputs.locationToken,
              }),
            }
          );

          const data = await response.json();
          displayResults(
            "resultsEmployees",
            {
              status: response.status,
              statusText: response.statusText,
              data: data,
            },
            !response.ok
          );
        } catch (error) {
          displayResults(
            "resultsEmployees",
            {
              error: "Network Error",
              message: error.message,
            },
            true
          );
        }
      }

      // Test Direct SOAP Call for Employees
      async function testEmployeesAPIDirectSOAP() {
        const inputs = getInputValues();
        if (!validateInputs(inputs, false)) return;

        // Show the SOAP envelope we're going to send
        const soapEnvelope = `<?xml version="1.0" encoding="utf-8"?>
    <soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/" xmlns:set="http://www.brinksoftware.com/webservices/settings/v2">
        <soap:Header />
        <soap:Body>
            <set:GetEmployees>
                <set:request>
                    <set:IncludeJobTypeInfo>true</set:IncludeJobTypeInfo>
                </set:request>
            </set:GetEmployees>
        </soap:Body>
    </soap:Envelope>`;

        displaySoapEnvelope(
          "soapEnvelopeEmployees",
          `SOAP Envelope (${soapEnvelope.length} chars):
${soapEnvelope}`
        );

        try {
          const response = await fetch(
            "https://api11.brinkpos.net/Settings2.svc",
            {
              method: "POST",
              headers: {
                AccessToken: inputs.accessToken,
                LocationToken: inputs.locationToken || "",
                "Content-Type": "text/xml",
                SOAPAction:
                  "http://www.brinksoftware.com/webservices/settings/v2/ISettingsWebService2/GetEmployees",
              },
              body: soapEnvelope,
            }
          );

          const responseText = await response.text();
          displayResults(
            "resultsEmployees",
            {
              status: response.status,
              statusText: response.statusText,
              headers: Object.fromEntries(response.headers.entries()),
              responseText:
                responseText.substring(0, 2000) +
                (responseText.length > 2000 ? "... (truncated)" : ""),
              fullResponseLength: responseText.length,
            },
            !response.ok
          );
        } catch (error) {
          displayResults(
            "resultsEmployees",
            {
              error: "Direct SOAP Call Failed",
              message: error.message,
              soapEnvelopeUsed: soapEnvelope,
            },
            true
          );
        }
      }

      // Test Labor Shifts API through Azure Function
      async function testLaborShiftsAPI() {
        const inputs = getInputValues();
        if (!validateInputs(inputs)) return;

        try {
          const response = await fetch(
            `${inputs.baseUrl}/par-brink/labor-shifts`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                accessToken: inputs.accessToken,
                locationToken: inputs.locationToken,
                businessDate: inputs.businessDate,
              }),
            }
          );

          const data = await response.json();
          displayResults(
            "resultsLaborShifts",
            {
              status: response.status,
              statusText: response.statusText,
              data: data,
            },
            !response.ok
          );
        } catch (error) {
          displayResults(
            "resultsLaborShifts",
            {
              error: "Network Error",
              message: error.message,
            },
            true
          );
        }
      }

      // Auto-detect if we're running locally (URL already set above)
      if (
        window.location.hostname === "localhost" ||
        window.location.hostname === "127.0.0.1"
      ) {
        console.log(
          "üè† Running locally - Azure Functions available at http://localhost:7071"
        );
      } else {
        console.log("‚òÅÔ∏è Running in browser - Using production Azure Functions");
      }
    </script>
  </body>
</html>
